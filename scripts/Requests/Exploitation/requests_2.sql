-- --------------------------------------------------------------------------
-- Récupérer les coordonnées de tous les clients qui ont reçu leur commande
-- --------------------------------------------------------------------------

SELECT 
    oc_order.order_id AS "# Order", oc_order_state.order_state AS "Order State",
    oc_user.title AS "Title", oc_user.lastname AS "Lastname", oc_user.firstname AS "Firstname",
    oc_contact.phone_number AS "Phone", oc_contact.street_number AS "# Street",
    oc_contact.street_name AS "Street", oc_contact.postal_code AS "Postal code",
    oc_contact.city AS "City"
FROM 
    oc_order
INNER JOIN oc_order_state ON 
    oc_order_state.order_state_id = oc_order.order_state_id
INNER JOIN oc_customer ON 
    oc_customer.customer_id = oc_order.customer_id
INNER JOIN oc_user ON 
    oc_user.user_id = oc_customer.user_id
INNER JOIN oc_contact ON 
    oc_contact.contact_id = oc_customer.contact_id
WHERE 
    oc_order_state.order_state_id = 5;

-- ------------------------------------------------
-- Récupérer le détail d'une commande d'un client
-- ------------------------------------------------

SELECT 
    oc_order.order_id AS "# Order", oc_user.title AS "Title", 
    oc_user.lastname AS "Lastname", oc_user.firstname AS "Firstname", 
    oc_pizza.name AS "Pizza", oc_pizza.unit_price_ht AS "Unit Price HT", 
    oc_item.quantity AS "Qty"
FROM 
    oc_order
INNER JOIN oc_customer ON 
    oc_customer.customer_id = oc_order.customer_id
INNER JOIN oc_user ON 
    oc_user.user_id = oc_customer.user_id
INNER JOIN oc_item ON 
    oc_item.order_id = oc_order.order_id
INNER JOIN oc_pizza ON 
    oc_pizza.pizza_id = oc_item.pizza_id
WHERE 
    oc_order.order_id = 98;

-- ----------------------------------------
-- Afficher le détail des factures payées
-- ----------------------------------------

SELECT 
    oc_bill.order_id AS "# Bill", oc_user.lastname AS "Lastname", 
    oc_user.firstname AS "Firstname",
    oc_payment_type.payment_type AS "Payment type",
    SUM(oc_item.quantity*oc_pizza.unit_price_ht) AS "Total HT",
    oc_bill.rate_vat100 AS "TVA",
    cast(SUM(oc_item.quantity*oc_pizza.unit_price_ht) + 
          SUM(oc_item.quantity*oc_pizza.unit_price_ht) * oc_bill.rate_vat100 / 100 
           AS decimal(5,2)) AS "Total TTC",
    oc_restaurant.name AS "Restaurant"
FROM 
    oc_bill
INNER JOIN oc_payment_type ON
    oc_payment_type.payment_type_id = oc_bill.payment_type_id
INNER JOIN oc_order ON 
    oc_order.order_id = oc_bill.order_id
INNER JOIN oc_customer ON 
    oc_customer.customer_id = oc_order.customer_id
INNER JOIN oc_user ON 
    oc_user.user_id = oc_customer.user_id 
INNER JOIN oc_item ON 
    oc_item.order_id = oc_order.order_id 
INNER JOIN oc_pizza ON 
    oc_pizza.pizza_id = oc_item.pizza_id 
INNER JOIN oc_restaurant ON 
    oc_restaurant.restaurant_id = oc_bill.restaurant_id
WHERE 
    oc_bill.payment_type_id != 4 
GROUP BY 
    oc_bill.order_id, oc_user.lastname, oc_user.firstname, 
    oc_payment_type.payment_type, oc_restaurant.name,
    oc_restaurant.restaurant_id
ORDER BY
    oc_restaurant.restaurant_id, oc_bill.order_id;

-- -----------------------------------------------------------
-- Afficher le détail de toutes les factures d'un restaurant
-- -----------------------------------------------------------

SELECT 
    oc_bill.order_id AS "# Bill", oc_user.lastname AS "Lastname", 
    oc_user.firstname AS "Firstname",
    oc_payment_type.payment_type AS "Payment type",
    SUM(oc_item.quantity*oc_pizza.unit_price_ht) AS "Total HT",
    oc_bill.rate_vat100 AS "TVA",
    cast(SUM(oc_item.quantity*oc_pizza.unit_price_ht) + 
          SUM(oc_item.quantity*oc_pizza.unit_price_ht) * oc_bill.rate_vat100 / 100 
           AS decimal(5,2)) AS "Total TTC",
    oc_restaurant.name AS "Restaurant"
FROM 
    oc_bill
INNER JOIN oc_payment_type ON
    oc_payment_type.payment_type_id = oc_bill.payment_type_id
INNER JOIN oc_order ON 
    oc_order.order_id = oc_bill.order_id
INNER JOIN oc_customer ON 
    oc_customer.customer_id = oc_order.customer_id
INNER JOIN oc_user ON 
    oc_user.user_id = oc_customer.user_id 
INNER JOIN oc_item ON 
    oc_item.order_id = oc_order.order_id 
INNER JOIN oc_pizza ON 
    oc_pizza.pizza_id = oc_item.pizza_id 
INNER JOIN oc_restaurant ON 
    oc_restaurant.restaurant_id = oc_bill.restaurant_id
WHERE
    oc_restaurant.restaurant_id = 2
GROUP BY 
    oc_bill.order_id, oc_user.lastname, oc_user.firstname,
    oc_payment_type.payment_type, oc_restaurant.name
ORDER BY
    oc_bill.order_id;

-- --------------------------------------------------------------------------
-- Récupérer login, mail et rôle de tous les employés d'un restaurant donné
-- --------------------------------------------------------------------------

SELECT 
    oc_user.login AS "Login", oc_user.email AS "Email", oc_role.role AS "Role", 
    oc_restaurant.name AS "Restaurant"
FROM 
    oc_employee
INNER JOIN oc_user ON 
    oc_user.user_id = oc_employee.user_id
INNER JOIN oc_role ON 
    oc_role.role_id = oc_employee.role_id
INNER JOIN oc_restaurant ON 
    oc_restaurant.restaurant_id = oc_employee.restaurant_id
WHERE 
    oc_restaurant.restaurant_id = 3
ORDER BY 
    oc_role.role_id;

-- ------------------------------------------------------------
-- Afficher le stock de tous les ingrédients d'un restaurant
-- ------------------------------------------------------------

SELECT 
    oc_ingredient.name AS "Ingredient", oc_stock.quantity AS "Stock (gr.)", 
    oc_restaurant.name AS "Restaurant"
FROM 
    oc_stock
INNER JOIN oc_ingredient ON 
    oc_ingredient.ingredient_id = oc_stock.ingredient_id
INNER JOIN oc_restaurant ON 
    oc_restaurant.restaurant_id = oc_stock.restaurant_id
WHERE 
    oc_restaurant.restaurant_id = 1;

-- -----------------------------------------------
-- Afficher toutes les commandes d'un restaurant
-- -----------------------------------------------

SELECT 
    oc_order.order_id AS "Order", oc_order_state.order_state AS "State", 
    oc_payment_type.payment_type AS "Payment type", 
    oc_restaurant.name AS "Restaurant"
FROM 
    oc_order
INNER JOIN oc_order_state ON 
    oc_order_state.order_state_id = oc_order.order_state_id
INNER JOIN oc_bill ON 
    oc_bill.order_id = oc_order.order_id
INNER JOIN oc_payment_type ON 
    oc_payment_type.payment_type_id = oc_bill.payment_type_id
INNER JOIN oc_restaurant ON 
    oc_restaurant.restaurant_id = oc_bill.restaurant_id
WHERE 
    oc_restaurant.restaurant_id = 4
ORDER BY 
    oc_order.order_id;

-- ---------------------------------------------------------------------
-- Afficher toutes les factures payées par CB et le restaurant associé
-- ---------------------------------------------------------------------

SELECT 
    oc_bill.order_id AS "# Bill", oc_payment_type.payment_type AS "Payment type", 
    oc_bill.date AS "Date", oc_restaurant.name AS "Restaurant"
FROM 
    oc_bill
INNER JOIN oc_payment_type ON 
    oc_payment_type.payment_type_id = oc_bill.payment_type_id
INNER JOIN oc_restaurant ON 
    oc_restaurant.restaurant_id = oc_bill.restaurant_id
WHERE 
    oc_payment_type.payment_type_id = 1;

-- ---------------------------------------------------
-- Récupérer le détail d'une commande payée en ligne
-- ---------------------------------------------------

SELECT 
    oc_order.order_id AS "# Order", oc_order.paid_online AS "Paid online", 
    oc_order.added_date AS "Date", oc_pizza.name AS "Pizza", 
    oc_pizza.unit_price_ht AS "Unit Price HT", oc_item.quantity AS "Qty"
FROM 
    oc_item
INNER JOIN oc_order ON 
    oc_order.order_id = oc_item.order_id
INNER JOIN oc_pizza ON 
    oc_pizza.pizza_id = oc_item.pizza_id
WHERE 
    oc_order.paid_online = 1 
AND 
    oc_order.order_id = 40;

-- --------------------------------------------------------------------------
-- Sélectionner les pizzas, prix HT et recettes des produits qui comportent 
-- des champignons
-- --------------------------------------------------------------------------

SELECT 
    oc_ingredient.name AS "Ingredient", oc_pizza.name AS "Pizza", 
    oc_pizza.unit_price_ht AS "Unit price", oc_reminder.description AS "Recipe"
FROM 
    oc_pizza 
INNER JOIN oc_pizza_ingredient ON 
    oc_pizza_ingredient.pizza_id = oc_pizza.pizza_id
INNER JOIN oc_ingredient ON 
    oc_ingredient.ingredient_id = oc_pizza_ingredient.ingredient_id
INNER JOIN oc_reminder ON
    oc_reminder.pizza_id = oc_pizza.pizza_id
WHERE 
    oc_ingredient.ingredient_id = 3;

-- -----------------------------------------------------------------
-- Déterminer le nombre de pizza restantes (par restaurant) depuis 
-- le stock (restant) d'un ingrédient
-- -----------------------------------------------------------------

SELECT
    oc_pizza.name AS "Pizza", oc_ingredient.name AS "Ingredient",
    FLOOR(oc_stock.quantity/oc_pizza_ingredient.quantity) AS "Nb. Pizza",
    oc_restaurant.name AS "Restaurant"

FROM oc_pizza
INNER JOIN oc_pizza_ingredient ON
    oc_pizza.pizza_id = oc_pizza_ingredient.pizza_id
INNER JOIN oc_ingredient ON
    oc_ingredient.ingredient_id = oc_pizza_ingredient.ingredient_id
INNER JOIN oc_stock ON
    oc_stock.ingredient_id = oc_ingredient.ingredient_id
INNER JOIN oc_restaurant ON
    oc_stock.restaurant_id = oc_restaurant.restaurant_id
WHERE
    oc_pizza.pizza_id = 7 AND oc_ingredient.name = 'Merguez'